#!/usr/bin/env python3
import docker, time, sys, subprocess

IMG = "vuln-apache"
NAME = "lab-web"

def ensure_web(client):
    try:
        c = client.containers.get(NAME)
        if c.status != "running":
            c.start()
        return c
    except docker.errors.NotFound:
        return client.containers.run(IMG, name=NAME, detach=True, tty=True, ports={"80/tcp":8080})

def main():
    client = docker.from_env()
    web = ensure_web(client)
    print("[*] Web container ready at http://localhost:8080/")
    subprocess.run(["bash", "-lc", "sed -i 's/\\r$//' exploit.sh; chmod +x exploit.sh"])
    subprocess.run(["./exploit.sh", "http://localhost:8080/index.php"], check=False)
    print("[+] Tail logs:")
    print(web.logs(tail=50).decode(errors="ignore"))
    return 0

if __name__ == "__main__":
    sys.exit(main())

